DROP TABLE IF EXISTS CLIENT_TRANSACTIONS CASCADE;
DROP TABLE IF EXISTS CURRENCY CASCADE;

CREATE TABLE CLIENT_TRANSACTIONS 
(
	  EVT_DT TIMESTAMP(0) 
	, CLIENT_ID INTEGER
	, CARD_ID INTEGER 
	, TRX_TYPE INTEGER 
	, TRX_DIRECTION CHAR(1) NOT NULL CHECK (TRX_DIRECTION IN ('D', 'C'))
	, AMNT FLOAT not null
	, CURRENCY_ID INTEGER 
	, PRIMARY KEY(CARD_ID , EVT_DT)
);

CREATE TABLE CURRENCY
(
 ID INTEGER PRIMARY KEY UNIQUE
, CODE INTEGER UNIQUE NOT NULL
, NAME VARCHAR(30)
);

COPY CLIENT_TRANSACTIONS
FROM 'D:\SBER_INTERN_TECH_TASK\CLIENT_TRANSACTIONS.csv'
DELIMITER ';'
CSV 
HEADER;

COPY CURRENCY
FROM 'D:\SBER_INTERN_TECH_TASK\TABLE_CURRENCY.csv'
DELIMITER ';'
CSV 
HEADER;

INSERT INTO CLIENT_TRANSACTIONS (EVT_DT, CLIENT_ID, CARD_ID, TRX_TYPE, TRX_DIRECTION, AMNT, CURRENCY_ID) 
VALUES 
('2024-03-05 11:10:15', 12345678, 987654, 1, 'D', 654.78, 810),
('2024-03-10 16:25:40', 87654321, 456789, 5, 'C', 2345.67, 840),
('2024-04-12 08:45:50', 23456789, 567890, 1, 'D', 876.54, 810),
('2024-04-18 12:35:55', 98765432, 678901, 5, 'C', 3456.78, 840),
('2024-05-20 14:50:30', 34567890, 789012, 1, 'D', 987.65, 810),
('2024-05-25 09:15:20', 67890123, 890123, 5, 'C', 24567.89, 840),
('2024-06-05 10:20:35', 45678901, 901234, 1, 'D', 21098.76, 810),
('2024-06-15 13:55:45', 78901234, 123456, 5, 'C', 25678.90, 840),
('2024-07-18 15:30:25', 56789012, 234567, 1, 'D', 21234.56, 810),
('2024-07-22 17:40:10', 89012345, 345678, 5, 'C', 36789.01, 840),
('2024-08-04 09:10:50', 67890123, 456789, 1, 'D', 41357.91, 810),
('2024-08-11 12:20:35', 90123456, 567890, 5, 'C', 57890.12, 840),
('2024-09-15 14:45:40', 78901234, 678901, 1, 'D', 61478.52, 810),
('2024-09-20 16:55:25', 12345678, 789012, 5, 'C', 78901.23, 840),
('2024-10-03 10:30:20', 56789012, 890123, 1, 'D', 81598.42, 810),
('2024-10-14 13:40:15', 89012345, 901234, 7, 'C', 39012.34, 840),
('2024-11-16 11:20:30', 23456789, 123456, 1, 'D', 1689.35, 810),
('2024-11-28 14:35:25', 90123456, 234567, 5, 'C', 1234.56, 840),
('2024-12-09 09:50:40', 34567890, 345678, 1, 'D', 1798.24, 810),
('2024-12-22 12:15:35', 67890123, 456789, 5, 'C', 9876.54, 840);


SELECT  CLIENT_ID AS "Объём клиентов", 
		SUM(AMNT) AS "Сумма покупок",
		COUNT(*) AS "Кол-во покупок",
		DATE_PART('MONTH',EVT_DT) AS "Месяц"
FROM CLIENT_TRANSACTIONS 
GROUP BY CLIENT_ID , DATE_PART('MONTH',EVT_DT)
HAVING COUNT(*) >= 7 AND  SUM(AMNT) >= 20000

